@using Newtonsoft.Json;
@model InvoiceApp.Web.Models.Invoices.CreateInvoiceVm
@{
    var products = ViewBag.Products as List<InvoiceApp.Web.Models.LookUps.ProductVm>;
    var units = ViewBag.Units as List<InvoiceApp.Web.Models.LookUps.UnitVm>;
    var stores = ViewBag.Stores as List<InvoiceApp.Web.Models.LookUps.StoreVm>;
}

<h2>Create Invoice</h2>

<div class="container">
    <form id="invoiceForm">

        <div class="row mb-3">
            <div class="col-md-4">
                <label>Invoice No</label>
                <input type="number" class="form-control" id="InvoiceNo" />
            </div>

            <div class="col-md-4">
                <label>Invoice Date</label>
                <input type="date" class="form-control" id="InvoiceDate" value="@Model.InvoiceDate.ToString("yyyy-MM-dd")" />
            </div>

            <div class="col-md-4">
                <label>Store</label>
                <select class="form-control" id="StoreId">
                    <option value="">-- Select Store --</option>
                    @foreach (var s in stores)
                    {
                        <option value="@s.Id">@s.Name</option>
                    }
                </select>
            </div>
        </div>

        <table class="table table-bordered" id="linesTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Unit</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Discount</th>
                    <th>Total</th>
                    <th>Net</th>
                    <th><button type="button" id="addRow" class="btn btn-success btn-sm">+</button></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="row mt-3">
            <div class="col-md-4">
                <label>Total</label>
                <input type="text" id="Total" class="form-control" readonly />
            </div>
            <div class="col-md-4">
                <label>Taxes</label>
                <input type="text" id="Taxes" class="form-control" readonly />
            </div>
            <div class="col-md-4">
                <label>Net</label>
                <input type="text" id="Net" class="form-control" readonly />
            </div>
        </div>

        <div class="mt-4 text-end">
            <button type="button" id="saveInvoice" class="btn btn-primary">Save</button>
            <a href="/Invoices" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        var products = @Html.Raw(JsonConvert.SerializeObject(products));
        var units = @Html.Raw(JsonConvert.SerializeObject(units));

        function renderRow() {
            let row = `
            <tr>
                <td><select class="form-control product-select">${products.map(p => `<option value="${p.Id}">${p.Name}</option>`).join('')}</select></td>
                <td><select class="form-control unit-select">${units.map(u => `<option value="${u.Id}">${u.Name}</option>`).join('')}</select></td>
                <td><input type="number" class="form-control qty" value="1" /></td>
                <td><input type="number" class="form-control price" value="0" /></td>
                <td><input type="number" class="form-control discount" min="0" value="0" /></td>
                <td><input type="text" class="form-control total" readonly /></td>
                <td><input type="text" class="form-control net" readonly /></td>
                <td><button type="button" class="btn btn-danger btn-sm removeRow">X</button></td>
            </tr>`;
            $("#linesTable tbody").append(row);
        }

        function calculateTotals() {
            let sumTotal = 0;
            let sumNet = 0;

            $("#linesTable tbody tr").each(function () {
                let qty = parseFloat($(this).find(".qty").val()) || 0;
                let price = parseFloat($(this).find(".price").val()) || 0;
                let discount = parseFloat($(this).find(".discount").val()) || 0;

                let total = qty * price;
                let net = total - discount;

                $(this).find(".total").val(total.toFixed(2));
                $(this).find(".net").val(net.toFixed(2));

                sumTotal += total;
                sumNet += net;
            });

            $("#Total").val(sumTotal.toFixed(2));
            let taxes = sumNet * 0.14;
            $("#Taxes").val(taxes.toFixed(2));
            $("#Net").val((sumNet + taxes).toFixed(2));
        }

        $(document).on("keyup change", ".qty, .price, .discount", calculateTotals);
        $("#addRow").click(() => { renderRow(); });
        $(document).on("click", ".removeRow", function () { $(this).closest("tr").remove(); calculateTotals(); });

        $("#saveInvoice").click(() => {
            let model = {
                InvoiceNo: $("#InvoiceNo").val(),
                InvoiceDate: $("#InvoiceDate").val(),
                StoreId: $("#StoreId").val(),
                Total: $("#Total").val(),
                Taxes: $("#Taxes").val(),
                Net: $("#Net").val(),
                Lines: []
            };

            $("#linesTable tbody tr").each(function () {
                model.Lines.push({
                    ProductId: $(this).find(".product-select").val(),
                    UnitId: $(this).find(".unit-select").val(),
                    Quantity: $(this).find(".qty").val(),
                    Price: $(this).find(".price").val(),
                    Discount: $(this).find(".discount").val(),
                    Total: $(this).find(".total").val(),
                    Net: $(this).find(".net").val()
                });
            });

            $.ajax({
                url: "/Invoice/CreateInvoice",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(model),
                success: () => alert("Invoice Created Successfully"),
                error: err => console.error("Error: " + err.responseText)
            });
        });

        renderRow();
    </script>
}
